
    <div class="d-flex justify-content-between">
        <a href="/campaign/campanas" class="btn btn-outline-danger">Volver</a>
    </div>

        <div class="d-flex align-items-center flex-column mt-3">
        <div id="añ-ag-reg" class="fs-3 p-2 fw-bold w-100">✨ <%= campana.nombre %></div>
        <div class="d-flex flex-column align-items-center w-100 pb-3 pt-2" style="background-color: var(--light-grey); border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;">
            
            <table class="w-100 px-5     table-auto border border-gray-300 text-sm text-center">
    <thead>
        <tr class="bg-gray-100">
            <th class="p-2 border">Nombre</th>
            <th class="p-2 border">Teléfono</th>
            <th class="p-2 border">Correo</th>
            <th class="p-2 border">Datos adicionales</th>
            <th class="p-2 border">Tipificación</th>
            <th class="p-2 border">Agente</th>
            <th class="p-2 border">Acciones</th>
        </tr>
    </thead>
    <tbody>
        <% registros.forEach(registro => { %>
            <tr>
                <td class="p-2 border"><%= registro.nombre %></td>
                <td class="p-2 border"><%= registro.telefono %></td>
                <td class="p-2 border"><%= registro.correo %></td>
                
                <td class="p-2 border">
                    <% Object.entries(registro.otrosCampos).forEach(([key, value]) => { %>
                        <strong><%= key %></strong>: <%= value %><br>
                    <% }) %>
                </td>

                <td class="p-2 border"><%= registro.tipificacion %></td>
                <td class="p-2 border"><%= registro.agente %></td>
                
                <td class="p-2 border">
                    <button class="btn btn-success btn-sm click-to-dial me-2"
                            data-phone="<%= registro.telefono %>"
                            data-lead-id="<%= registro.id %>"
                            data-lead-name="<%= registro.nombre %>"
                            title="Llamar a <%= registro.nombre %>">
                        <i class="fas fa-phone"></i>
                    </button>
                    <a href="/campaign/campanas/<%= campana.id %>/gestionar/<%= registro.id %>"
                    class="btn btn-primary btn-sm" style="background-color: var(--corporate-mint); outline: none; border: none; color: white;">
                        Gestionar
                    </a>
                </td>
            </tr>
        <% }) %>
    </tbody>
</table>



        </div>
            </div>

<!-- Sprint 3.2.5: Click-to-Dial JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Click-to-dial functionality
    document.querySelectorAll('.click-to-dial').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();

            const phone = this.dataset.phone;
            const leadId = this.dataset.leadId;
            const leadName = this.dataset.leadName;

            console.log('[Click-to-Dial] Initiating call to:', phone, 'for lead:', leadName);

            // Check if softphone is available
            if (typeof window.softphoneUI === 'undefined') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Softphone no disponible',
                    html: `
                        <p>El softphone no está disponible en esta página.</p>
                        <p>Por favor, ve al <strong>Agent Workstation</strong> para realizar llamadas.</p>
                    `,
                    confirmButtonText: 'Ir a Agent Workstation',
                    showCancelButton: true,
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '/agent/workstation';
                    }
                });
                return;
            }

            // Populate softphone and optionally auto-dial
            try {
                // Set the phone number in the softphone input
                if (window.softphoneUI.elements && window.softphoneUI.elements.phoneInput) {
                    window.softphoneUI.elements.phoneInput.value = phone;
                    window.softphoneUI.currentNumber = phone;

                    // Store lead context for the call
                    window.softphoneUI.currentLeadId = leadId;
                    window.softphoneUI.currentLeadName = leadName;

                    // Show confirmation before auto-dialing
                    Swal.fire({
                        icon: 'question',
                        title: `Llamar a ${leadName}?`,
                        html: `
                            <p>Número: <strong>${phone}</strong></p>
                            <p>¿Deseas iniciar la llamada ahora?</p>
                        `,
                        showCancelButton: true,
                        confirmButtonText: '<i class="fas fa-phone"></i> Llamar',
                        cancelButtonText: 'Solo cargar número',
                        confirmButtonColor: '#10b981'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Auto-dial
                            if (typeof window.softphoneUI.makeCall === 'function') {
                                window.softphoneUI.makeCall();
                            } else {
                                console.error('[Click-to-Dial] makeCall method not available');
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'No se pudo iniciar la llamada. Por favor, intenta desde el softphone.'
                                });
                            }
                        } else {
                            // Just show notification that number is loaded
                            Swal.fire({
                                icon: 'success',
                                title: 'Número cargado',
                                text: `El número ${phone} está listo en el softphone.`,
                                timer: 2000,
                                showConfirmButton: false
                            });
                        }
                    });
                } else {
                    throw new Error('Softphone UI elements not available');
                }
            } catch (error) {
                console.error('[Click-to-Dial] Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo cargar el número en el softphone. Por favor, intenta manualmente.'
                });
            }
        });
    });
});
</script>

