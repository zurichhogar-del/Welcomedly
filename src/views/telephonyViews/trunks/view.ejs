<!-- Vista de Detalles de Troncal SIP - Sprint 3.1.6 -->
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Detalles de Troncal: <%= trunk.name %></h1>
                <div class="btn-group">
                    <a href="/trunks" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                    <a href="/trunks/<%= trunk.id %>/editar" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <button type="button"
                            class="btn btn-info"
                            onclick="testTrunk('<%= trunk.id %>', '<%= trunk.name %>')">
                        <i class="bi bi-lightning"></i> Probar Conexión
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna Principal -->
        <div class="col-lg-8">
            <!-- Información Básica -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información Básica</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Nombre</label>
                            <p class="mb-0"><strong><%= trunk.name %></strong></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Proveedor</label>
                            <p class="mb-0">
                                <span class="badge bg-info fs-6">
                                    <%= trunk.provider.toUpperCase() %>
                                </span>
                            </p>
                        </div>
                    </div>

                    <% if (trunk.description) { %>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="text-muted small">Descripción</label>
                            <p class="mb-0"><%= trunk.description %></p>
                        </div>
                    </div>
                    <% } %>

                    <div class="row">
                        <div class="col-md-4">
                            <label class="text-muted small">Tipo de Troncal</label>
                            <p class="mb-0">
                                <span class="badge bg-secondary">
                                    <%= trunk.trunkType.toUpperCase() %>
                                </span>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Canales Máximos</label>
                            <p class="mb-0"><%= trunk.maxChannels %> simultáneos</p>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Prioridad</label>
                            <p class="mb-0"><%= trunk.priority %></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuración de Conexión -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-globe"></i> Configuración de Conexión</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="text-muted small">Host</label>
                            <p class="mb-0"><code><%= trunk.host %></code></p>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Puerto</label>
                            <p class="mb-0"><code><%= trunk.port %></code></p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="text-muted small">Usuario/Account SID</label>
                            <p class="mb-0">
                                <%= trunk.username ? trunk.username : '<span class="text-muted">No configurado</span>' %>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Contraseña</label>
                            <p class="mb-0">
                                <%= trunk.password ? '••••••••••••' : '<span class="text-muted">No configurada</span>' %>
                            </p>
                        </div>
                    </div>

                    <% if (trunk.fromUser || trunk.fromDomain) { %>
                    <hr>
                    <div class="row">
                        <% if (trunk.fromUser) { %>
                        <div class="col-md-6">
                            <label class="text-muted small">From User</label>
                            <p class="mb-0"><code><%= trunk.fromUser %></code></p>
                        </div>
                        <% } %>
                        <% if (trunk.fromDomain) { %>
                        <div class="col-md-6">
                            <label class="text-muted small">From Domain</label>
                            <p class="mb-0"><code><%= trunk.fromDomain %></code></p>
                        </div>
                        <% } %>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Estadísticas de Llamadas</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h3 class="mb-1 text-primary"><%= stats.stats.totalCalls || 0 %></h3>
                                <p class="mb-0 small text-muted">Total de Llamadas</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h3 class="mb-1 text-success"><%= stats.stats.successfulCalls || 0 %></h3>
                                <p class="mb-0 small text-muted">Exitosas</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h3 class="mb-1 text-danger"><%= stats.stats.failedCalls || 0 %></h3>
                                <p class="mb-0 small text-muted">Fallidas</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h3 class="mb-1 text-warning"><%= stats.stats.activeCalls || 0 %></h3>
                                <p class="mb-0 small text-muted">Activas Ahora</p>
                            </div>
                        </div>
                    </div>

                    <% if (stats.stats.totalCalls > 0) { %>
                    <hr>
                    <div class="text-center">
                        <p class="mb-0">
                            <strong>Tasa de Éxito:</strong>
                            <span class="badge bg-<%= stats.stats.successRate >= 70 ? 'success' : (stats.stats.successRate >= 50 ? 'warning' : 'danger') %> fs-6">
                                <%= stats.stats.successRate %>%
                            </span>
                        </p>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Campañas Asignadas -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-purple text-white" style="background-color: #6f42c1;">
                    <h5 class="mb-0"><i class="bi bi-megaphone"></i> Campañas Asignadas</h5>
                </div>
                <div class="card-body">
                    <% if (trunk.campaigns && trunk.campaigns.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Campaña</th>
                                        <th>Descripción</th>
                                        <th class="text-center">Prioridad</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% trunk.campaigns.forEach(campaign => { %>
                                        <tr>
                                            <td><strong><%= campaign.nombre %></strong></td>
                                            <td>
                                                <small class="text-muted">
                                                    <%= campaign.descripcion ? campaign.descripcion.substring(0, 50) : 'Sin descripción' %>
                                                    <%= campaign.descripcion && campaign.descripcion.length > 50 ? '...' : '' %>
                                                </small>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-light text-dark">
                                                    <%= campaign.campaign_trunks ? campaign.campaign_trunks.priority : 'N/A' %>
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger"
                                                        onclick="removeCampaign('<%= trunk.id %>', '<%= campaign.id %>', '<%= campaign.nombre %>')">
                                                    <i class="bi bi-x-circle"></i> Remover
                                                </button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i>
                            Esta troncal no está asignada a ninguna campaña.
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Columna Lateral -->
        <div class="col-lg-4">
            <!-- Estado -->
            <div class="card shadow-sm mb-4">
                <div class="card-header <%= trunk.status === 'active' ? 'bg-success' : (trunk.status === 'maintenance' ? 'bg-warning' : 'bg-secondary') %> text-white">
                    <h5 class="mb-0"><i class="bi bi-circle-fill"></i> Estado</h5>
                </div>
                <div class="card-body text-center">
                    <% if (trunk.status === 'active') { %>
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                        <h4 class="mt-2 text-success">Activa</h4>
                        <p class="text-muted mb-0">Troncal operativa y disponible</p>
                    <% } else if (trunk.status === 'inactive') { %>
                        <i class="bi bi-x-circle text-secondary" style="font-size: 3rem;"></i>
                        <h4 class="mt-2 text-secondary">Inactiva</h4>
                        <p class="text-muted mb-0">Troncal deshabilitada</p>
                    <% } else if (trunk.status === 'maintenance') { %>
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h4 class="mt-2 text-warning">Mantenimiento</h4>
                        <p class="text-muted mb-0">Troncal en mantenimiento</p>
                    <% } else { %>
                        <i class="bi bi-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                        <h4 class="mt-2 text-danger">Error</h4>
                        <p class="text-muted mb-0">Verificar configuración</p>
                    <% } %>
                </div>
            </div>

            <!-- Metadatos -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Información del Sistema</h5>
                </div>
                <div class="card-body">
                    <p class="small mb-2">
                        <strong>ID:</strong><br>
                        <code><%= trunk.id %></code>
                    </p>
                    <p class="small mb-2">
                        <strong>Creada:</strong><br>
                        <%= new Date(trunk.createdAt).toLocaleString('es-ES', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) %>
                    </p>
                    <p class="small mb-0">
                        <strong>Última actualización:</strong><br>
                        <%= new Date(trunk.updatedAt).toLocaleString('es-ES', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) %>
                    </p>
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="card shadow-sm border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Acciones Rápidas</h5>
                </div>
                <div class="card-body d-grid gap-2">
                    <button type="button"
                            class="btn btn-outline-info"
                            onclick="testTrunk('<%= trunk.id %>', '<%= trunk.name %>')">
                        <i class="bi bi-lightning"></i> Probar Conexión
                    </button>
                    <a href="/trunks/<%= trunk.id %>/editar" class="btn btn-outline-warning">
                        <i class="bi bi-pencil"></i> Editar Configuración
                    </a>
                    <button type="button"
                            class="btn btn-outline-danger"
                            onclick="deleteTrunk('<%= trunk.id %>', '<%= trunk.name %>')">
                        <i class="bi bi-trash"></i> Eliminar Troncal
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script>
// Test trunk connection
async function testTrunk(trunkId, trunkName) {
    try {
        Swal.fire({
            title: 'Probando conexión',
            text: `Verificando conectividad con ${trunkName}...`,
            icon: 'info',
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const response = await fetch(`/trunks/${trunkId}/test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
            }
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                title: 'Conexión exitosa',
                text: data.data.message,
                icon: 'success'
            });
        } else {
            throw new Error(data.error || 'Error al probar conexión');
        }
    } catch (error) {
        Swal.fire({
            title: 'Error',
            text: `No se pudo conectar: ${error.message}`,
            icon: 'error'
        });
    }
}

// Delete trunk
async function deleteTrunk(trunkId, trunkName) {
    const result = await Swal.fire({
        title: '¿Eliminar troncal?',
        html: `¿Estás seguro de eliminar la troncal <strong>${trunkName}</strong>?<br><small class="text-muted">Esta acción no se puede deshacer.</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/trunks/${trunkId}/eliminar`;

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = document.querySelector('meta[name="csrf-token"]')?.content || '';
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
}

// Remove campaign
async function removeCampaign(trunkId, campaignId, campaignName) {
    const result = await Swal.fire({
        title: '¿Remover campaña?',
        html: `¿Deseas remover la asignación de <strong>${campaignName}</strong> de esta troncal?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#0d6efd',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, remover',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const response = await fetch(`/trunks/${trunkId}/remove/${campaignId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
                }
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    title: 'Campaña removida',
                    text: 'La campaña ha sido removida de esta troncal',
                    icon: 'success'
                }).then(() => {
                    location.reload();
                });
            } else {
                throw new Error(data.error || 'Error al remover campaña');
            }
        } catch (error) {
            Swal.fire({
                title: 'Error',
                text: `No se pudo remover la campaña: ${error.message}`,
                icon: 'error'
            });
        }
    }
}
</script>

<style>
code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
}

.table td {
    vertical-align: middle;
}
</style>
