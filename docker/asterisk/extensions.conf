;
; Dialplan for Welcomedly
; Sprint 3.1.4 - Call Routing Logic
;

[general]
static=yes
writeprotect=no

;========== Welcomedly Agents Context ==========

[welcomedly-agents]
; Agent-to-agent calls
exten => _1XXX,1,NoOp(Agent to agent call: ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30)
 same => n,Hangup()

; Test echo extension
exten => 8888,1,NoOp(Echo test)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; Voicemail test
exten => 9999,1,NoOp(Voicemail test)
 same => n,Answer()
 same => n,Playback(hello-world)
 same => n,Hangup()

;========== Outbound Calls Context ==========

[welcomedly-outbound]
; Outbound calls via trunk
; Format: External number (e.g., +1234567890)
exten => _+X.,1,NoOp(Outbound call to ${EXTEN} via trunk)
 same => n,Set(TRUNK_NAME=${DB(call/${UNIQUEID}/trunk)})
 same => n,GotoIf($["${TRUNK_NAME}" = ""]?use-default)
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK_NAME},60)
 same => n,Hangup()
 same => n(use-default),Dial(PJSIP/${EXTEN}@twilio-endpoint,60)
 same => n,Hangup()

; North American numbers without +
exten => _1NXXNXXXXXX,1,NoOp(Outbound call to ${EXTEN})
 same => n,Goto(+${EXTEN},1)

; 10-digit numbers
exten => _NXXNXXXXXX,1,NoOp(Outbound call to ${EXTEN})
 same => n,Goto(+1${EXTEN},1)

;========== Inbound Calls Context ==========

[welcomedly-inbound]
; Inbound calls from trunk
; Route to queue based on campaign
exten => _X.,1,NoOp(Inbound call from ${CALLERID(num)})
 same => n,Set(CAMPAIGN_ID=${DB(did/${EXTEN}/campaign)})
 same => n,GotoIf($["${CAMPAIGN_ID}" = ""]?no-campaign)
 same => n,Queue(campaign_${CAMPAIGN_ID},t,,,300)
 same => n,Hangup()
 same => n(no-campaign),Playback(invalid)
 same => n,Hangup()

;========== Default Context ==========

[default]
; Fallback context
exten => _X.,1,NoOp(Call to ${EXTEN} - no route)
 same => n,Playback(invalid)
 same => n,Hangup()
